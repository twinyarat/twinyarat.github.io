<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Tutch Sottithat Winyarat | A collection of robotics research related to Computer Vision and State Estimation. University of Pennsylvania 2021</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Tutch Sottithat Winyarat" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A collection of robotics research related to Computer Vision and State Estimation. University of Pennsylvania 2021" />
<meta property="og:description" content="A collection of robotics research related to Computer Vision and State Estimation. University of Pennsylvania 2021" />
<link rel="canonical" href="twinyarat.github.io/notes/quadController/" />
<meta property="og:url" content="twinyarat.github.io/notes/quadController/" />
<meta property="og:site_name" content="Tutch Sottithat Winyarat" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Tutch Sottithat Winyarat" />
<script type="application/ld+json">
{"description":"A collection of robotics research related to Computer Vision and State Estimation. University of Pennsylvania 2021","url":"twinyarat.github.io/notes/quadController/","headline":"Tutch Sottithat Winyarat","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="twinyarat.github.io/feed.xml" title="Tutch Sottithat Winyarat" /><!-- for mathjax support -->
	
	  <script type="text/x-mathjax-config">
	    MathJax.Hub.Config({
	    TeX: { equationNumbers: { autoNumber: "AMS" } }
	    });
	  </script>
	  <script type="text/javascript" async src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Tutch Sottithat Winyarat</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/notes/">Notes</a><a class="page-link" href="/projects/">Projects</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <h3 id="a-nonlinear-controller-for-quadrotors"><strong>A Nonlinear Controller For Quadrotors</strong></h3>
<hr />
<hr />
<p>\(\)</p>

<p>Given two coupled differential equations governing the motion of a quadrotor below, we set out to build a controller to achieve some desired behavior prescribed by a reference trajectory.</p>

\[\begin{align*} m\ddot{r} &amp;= \begin{bmatrix} 0 \\ 0\\ -mg	\end{bmatrix} + {}^A[R]^B \begin{bmatrix} 0 \\ 0\\ \sum_{i = 1}^{4} F_i	\end{bmatrix}  \\
&amp; = \begin{bmatrix} 0 \\ 0\\ -mg	\end{bmatrix} + {}^A[R]^B \begin{bmatrix} 0 \\ 0 \\ u_1\end{bmatrix} &amp;\tag{ 1}
\end{align*}\]

<p>\(\begin{align*} \begin{bmatrix} I_{xx} &amp; 0 &amp;0 \\ 0 &amp; I_{yy} &amp; 0 \\ 0 &amp; 0 &amp; I_{zz}	\end{bmatrix} \begin{bmatrix} \dot{p} \\ \dot{q}\\ \dot{r}	\end{bmatrix}  &amp;= \begin{bmatrix} 0 &amp; L &amp; 0 &amp;-L \\ -L &amp; 0 &amp; L &amp; 0 \\ \gamma &amp; -\gamma &amp; \gamma &amp; -\gamma \end{bmatrix} \begin{bmatrix} F_1 \\ F_2 \\ F_3 \\ F_4 \end{bmatrix}  - \begin{bmatrix} 0 &amp; -r &amp; q \\ r &amp; 0 &amp; -p \\ -q &amp; p &amp; 0\end{bmatrix}\begin{bmatrix} I_{xx} &amp; 0 &amp;0 \\ 0 &amp; I_{yy} &amp; 0 \\ 0 &amp; 0 &amp; I_{zz}	\end{bmatrix} \begin{bmatrix} p \\ q \\ r \end{bmatrix}  \\
I_c \begin{bmatrix} \dot{p} \\ \dot{q}\\ \dot{r}	\end{bmatrix}  &amp;= u_2  - \begin{bmatrix} 0 &amp; -r &amp; q \\ r &amp; 0 &amp; -p \\ -q &amp; p &amp; 0\end{bmatrix}I_c \begin{bmatrix} p \\ q \\ r \end{bmatrix}  &amp;\tag{ 2} \end{align*}\) <br />
\(\)(All terms are as defined in this <a href="\notes\quadmotion">note</a>)</p>

<p>Upon initial inspection, eq.1 tells us that we are working with an underactuated system; the system is underactuated because no control input \(u_1\) is be able to instantaneously accelerate the quadrotor in any arbitrary direction except in the direction of the body-fixed \(b_{3}\) axis that changes with the quadrotor’s relative orientation \(^A[R]^B\). Eq.2, on the other hand, allows us to instantaneously command (within physical constraints) any abitrary angular rates and in turn manipulate the orientation of the quadrotor. A controller capable of causing some desired translational motion should therefore be able to, as a prerequisite, achieve some desired orientation at a higher rate than it does translational motion. We proceed by solving the two subproblems in isolation.</p>

<hr />
<p>\(\)</p>
<h4 id="attitude-control"><strong>Attitude Control</strong></h4>

<p>Let \(q\) be a generalized coordinate of the system and \(q_{des}\) some desired reference coordinate. The tracking error is</p>

\[e_q =  q - q_{des}\]

<p>As proposed in <a class="citation" href="#minimumSnap">(Mellinger &amp; Kumar, 2011)</a>, we utilize a PD controller to drive the error \(e_q\) to zero. The behavior of \(e_q\) is governed by:</p>

\[\begin{align*} \ddot{e}_{q} &amp;= -K_d\dot{e}_q -K_pe_q \\
  \ddot{q}  &amp;=  \ddot{q}_{des}- K_d(\dot{q} - \dot{q}_{des}) - K_p( q - q_{des}) &amp;\tag{3 }
\end{align*}\]

<p>where \(K_p\) and \(K_d\) are proportional and derivative gains, respectively. When \(q\) is an angular object that does not reside in \(\mathbb{R}^n\), what should its corresponding attitude error \(e_q\) be?</p>

<p>Let \({}^A[R]^B = R\) be a rotation matrix describing the current orientation of the quadrotor and \(R_{des}\) a matrix describing some desired orientation. Define another matrix \(R_e\) to be a transformation that rotates \(R^T = {}^B[R]^A\) into \(R_{des}^T\)</p>

\[\begin{align*} R_eR^T &amp;= R^T_{des}  \\
R_e &amp;= R^T_{des}R \\
&amp;= I \cdot cos(\theta_e) + nn^T(1-cos(\theta_e)) + sin(\theta_e ) \hat{n} 
\end{align*}\]

<p>where \(n\) and \(\theta_e\) parameterize an <a href="\notes\rodrigues">axis-angle representation</a> of \(R_e\), and \(I\) an identity matrix. Taking \(R_e\)’s symmetric difference, we have</p>

\[\begin{align*}
 R_e - R_e^T &amp;= 2 sin(\theta_e) \hat{n} \\
 \frac{1}{2}(R_e - R_e^T) &amp; = sin(\theta_e) \hat{n} \\
 e_r &amp;= \frac{1}{2}\{R_e - R_e^T\}^{v} \tag{4}
\end{align*}\]

<p>where \((\cdot)^{v} = \hat{(\cdot)}^{-1}: SO(3) \mapsto  \mathbb{R}^3\), and \(e_r\) is the corresponding vector of rotational error. As pointed out in <a class="citation" href="#geometrictracking">(Lee et al., 2010)</a>, it’s important to note that the stability of the system’s attitude critically depends on the initital value of \(\theta_e\). An initital error of \(\vert \theta_e \vert &gt; \frac{\pi}{2}\) could potentiallly steer the system’s attitude away from its region of attraction and towards \(\theta_e = \pi\) because of \(sin(\theta_e)\) in eq.4. Nevertheless, unlike \(e_r\), the error in angular velocity \(e_{\omega}\) expressed in the coordinates of the body-fixed frame is simpler to compute:</p>

\[e_r =  \omega - \omega_{des}  \tag{5}\]

<p>For negligible values of the quadrotor’s own angular acceleration \(\dot{\omega}\), substituting eq.4 and eq.5 into eq.3 yields an expression of the angular acceleration we wish to command:</p>

\[\begin{align*} \dot{\omega}_{des} = \begin{bmatrix} \dot{p} &amp; \dot{q} &amp; \dot{r} \end{bmatrix}^T &amp;=   \dot{\omega} - K_{\omega} \cdot e_{\omega} - K_r \cdot  e_r \\
 &amp; = - K_{\omega}\cdot e_{\omega} - K_r \cdot e_r \tag{6}
  \end{align*}\]

<p>, which when substituted into eq.2, in turn gives an expression of the moment control \(u_2\):</p>

\[\begin{align*} u_2 &amp;= I_c \cdot (- K_{\omega}\cdot e_{\omega} - K_r \cdot e_r)   + \begin{bmatrix} 0 &amp; -r &amp; q \\ r &amp; 0 &amp; -p \\ -q &amp; p &amp; 0\end{bmatrix}I_c \begin{bmatrix} p \\ q \\ r \end{bmatrix}\\
&amp;= I_c \cdot (- K_{\omega}\cdot e_{\omega} - K_r \cdot e_r) \tag{7}
\end{align*}\]

<p>We here assume that due natural cancellation via the inclusion of feedback terms and/or the quasi-symmetric distribution of mass about its principal axes of inertia, \(\omega \times I_c \cdot \omega\) vanishes or becomes negligible.</p>

<hr />
<p>\(\)</p>
<h4 id="position-control"><strong>Position Control</strong></h4>

<p>Similar to designing the controller for angular motion, we would as well like to exponentially drive the translational motion error to zero. From eq.3 once again, the translational error by design behaves according to</p>

\[\ddot{r}  = \ddot{r}_{des} - K_d(\dot{r} - \dot{r}_{des}) - K_p( r - r_{des}) \tag{8}\]

<p>where \(\dot{r}\) and \(r\) are system’s states returned by its <a href="\notes\kalman">state estimator</a>, and \(\ddot{r}_{des} , \dot{r}_{des}\), and \({r}_{des}\) all prescribed by a reference trajectory. With the expression of \(\ddot{r}\) from eq.8, we are able to compute the force vector \(\boldsymbol{F}_{des}\) we would like \(u_1\) to achieve.</p>

\[\boldsymbol{F}_{des} = m \ddot{r} + \begin{bmatrix} 0 \\ 0 \\ mg  \end{bmatrix}\]

<p>where \(m\) and \(g\) are the quadrotor’s mass and Earth’s gravitational field, repectively. The remaining work is to compute the desired orientation \({}^A[R]^B_{des}\) from a reference yaw angle \(\psi_{des}\) prescribed by a reference trajectory and the desired force vector \(\boldsymbol{F}_{des}\). Given a desired \(\boldsymbol{F}_{des}\), we align the body-fixed \(b_3\) axis with it. Like so,</p>

\[b_{3,des} = \frac{\boldsymbol{F}_{des}}{ \lVert \boldsymbol{F}_{des}  
\lVert}\]

<p>We also let</p>

\[b_{1,des} = \begin{bmatrix} cos(\psi_{des}) &amp; sin(\psi_{des}) &amp; 0 \end{bmatrix}^T\]

<p>and</p>

\[b_{2,des} = \frac{b_{3,des} \times b_{1,des}}{ \lVert b_{3,des} \times b_{1,des} \lVert}\]

<p>such that they collectively describe the desired orientation:</p>

\[{}^A[R]^B_{des} = \begin{bmatrix} b_{1,des} &amp; b_{2,des} &amp; b_{3,des}\end{bmatrix}\]

<p>And since the input thrust is only in the body-fixed current \(b_3\) direction,</p>

\[u_1 = \boldsymbol{F}_{des}\cdot b_3\]

<p>This way, once \(b_3 = b_{3,des}\), then \(\boldsymbol{F}_{des}\) can be fully realized. And lastly, to determine the corresponding speeds \(\omega_{p,i}\) of the quadrotor’s propellers, first stack \(u_1\) and \(u_2\)</p>

\[u = \begin{bmatrix} u_1 \\ u_2 \end{bmatrix}\]

<p>so that, according to eq.1,</p>

\[\begin{align*}
u &amp;= \underbrace{\begin{bmatrix} 1 &amp; 1&amp; 1&amp; 1 \\ L &amp; 0 &amp;-L &amp; 0 \\ -L &amp; 0 &amp; L &amp; 0 \\ \gamma &amp; -\gamma &amp; \gamma &amp; -\gamma \end{bmatrix}}_{:= P} \begin{bmatrix} F_1 \\ F_2 \\ F_3 \\ F_4 \end{bmatrix} \\
&amp; \begin{bmatrix} F_1 \\ F_2 \\ F_3 \\ F_4 \end{bmatrix} = P^{-1} u \\
\end{align*}\]

<p>And given that the quadrotor’s propeller \(i\) spins with an angular velocity of \(\omega_i\), generating a force \(F_i = k_f\omega_i^2\) in the body-fixed \(b_3\) direction and a moment \(M_i = k_m \omega_i^2\) about \(b_3\),</p>

\[\begin{bmatrix} \omega_{p,1} &amp; \omega_{p,2} &amp; \omega_{p,3} &amp; \omega_{p,4} \end{bmatrix}  = \frac{1}{\sqrt{k_f}}\begin{bmatrix} \sqrt{F_1} &amp; \sqrt{F_2} &amp; \sqrt{F_3} &amp; \sqrt{F_4} \end{bmatrix}\]

<p>where \(k_f\) is the propeller’s gain discussed <a href="/notes/quadmotion/">here</a>. We have here recovered an appropriate set of underlying propeller speeds consistent with a desired system behavior.</p>

<hr />
<hr />

<p>\(\)</p>
<h3 id="references">References</h3>
<ol class="bibliography"><li><span id="minimumSnap">Mellinger, D., &amp; Kumar, V. (2011). Minimum snap trajectory generation and control for quadrotors. <i>2011 IEEE International Conference on Robotics and Automation</i>, 2520–2525.</span></li>
<li><span id="geometrictracking">Lee, T., Leok, M., &amp; McClamroch, N. H. (2010). Geometric tracking control of a quadrotor UAV on SE(3). <i>49th IEEE Conference on Decision and Control (CDC)</i>, 5420–5425.</span></li></ol>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Tutch Sottithat Winyarat</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Tutch Sottithat Winyarat</li><li><a class="u-email" href="mailto:winyarat@seas.upenn.edu">winyarat@seas.upenn.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/twinyarat"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">twinyarat</span></a></li><li><a href="https://www.linkedin.com/in/winyarat"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">winyarat</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A collection of robotics research related to Computer Vision and State Estimation. University of Pennsylvania 2021</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
